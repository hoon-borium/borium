<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard by Borium AI</title>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 720px; margin: 40px auto; }
      textarea { width: 100%; height: 120px; }
      pre { background: #f6f6f6; padding: 12px; border-radius: 8px; white-space: pre-wrap; }
      .row { margin: 16px 0; }
      .hint { font-size: 12px; color: #666; }
      .file-meta { font-size: 14px; color: #333; margin-top: 6px; }
      button { padding: 8px 14px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
  </head>
  <body>
    <h1>Borium AI Summary</h1>

    <div class="row">
      <textarea id="q" placeholder="e.g.) favourite menu yesterday?"></textarea>
    </div>

    <div class="row">
      <label for="file"><strong>Add file</strong></label><br />
      <input
        id="file"
        type="file"
        accept=".xlsx,.xls,.csv,.xlsm,.xlsb,.ods"
      />
      <div class="hint">xlsx/CSV available</div>
      <div id="fileMeta" class="file-meta"></div>
    </div>

    <div class="row">
      <button id="send">Ask</button>
      <button id="clearFile" type="button">Remove attached file</button>
    </div>

    <h3>Answer</h3>
    <pre id="answer">-</pre>

    <script>
      const API_URL = "https://7mx3ummxjg.execute-api.eu-west-2.amazonaws.com/qa";
      const sendBtn = document.getElementById("send");
      const fileInput = document.getElementById("file");
      const fileMeta = document.getElementById("fileMeta");
      const clearBtn = document.getElementById("clearFile");
      const answerEl = document.getElementById("answer");

      fileInput.addEventListener("change", () => {
        const f = fileInput.files?.[0];
        if (!f) { fileMeta.textContent = ""; return; }
        const sizeKB = (f.size / 1024).toFixed(1);
        fileMeta.textContent = `ì„ íƒë¨: ${f.name} (${sizeKB} KB, ${f.type || "application/octet-stream"})`;
      });

      // ì²¨ë¶€ ì œê±°
      clearBtn.onclick = () => {
        fileInput.value = "";
        fileMeta.textContent = "";
      };

      // ArrayBuffer -> Base64 (ëŒ€ìš©ëŸ‰ ì•ˆì „í•˜ê²Œ chunk ë³€í™˜)
      function arrayBufferToBase64(buffer) {
        let binary = "";
        const bytes = new Uint8Array(buffer);
        const chunkSize = 0x8000; // 32KB
        for (let i = 0; i < bytes.length; i += chunkSize) {
          const chunk = bytes.subarray(i, i + chunkSize);
          binary += String.fromCharCode.apply(null, chunk);
        }
        return btoa(binary);
      }

      async function readFileAsBase64(file) {
        const buf = await file.arrayBuffer();
        return arrayBufferToBase64(buf);
      }

      sendBtn.onclick = async () => {
        const question = document.getElementById("q").value.trim();
        if (!question) {
          alert("ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
          return;
        }

        answerEl.textContent = "Processing...";
        sendBtn.disabled = true;

        try {
          const f = fileInput.files?.[0];

          // ğŸ‘‰ Lambdaì—ì„œ ê¸°ëŒ€í•˜ëŠ” í˜•íƒœ: file_name / file_base64
          let file_name = null;
          let file_base64 = null;

          if (f) {
            // ê°„ë‹¨í•œ í”„ë¡ íŠ¸ ë‹¨ ê²€ì¦ (í¬ê¸°/í™•ì¥ì)
            const allowed = /\.(xlsx|xls|csv|xlsm|xlsb|ods)$/i.test(f.name);
            if (!allowed) {
              throw new Error("í—ˆìš©ë˜ì§€ ì•Šì€ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (xlsx, xls, csv, xlsm, xlsb, ods)");
            }
            // í•„ìš” ì‹œ ì‚¬ì´ì¦ˆ ì œí•œ (ì˜ˆ: 5MB)
            const maxBytes = 5 * 1024 * 1024;
            if (f.size > maxBytes) {
              throw new Error("íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.");
            }

            const contentBase64 = await readFileAsBase64(f);
            file_name = f.name;
            file_base64 = contentBase64;
          }

          // ğŸ”´ ê¸°ì¡´: { question, file: { filename, contentBase64, ... } }
          // ğŸŸ¢ ìˆ˜ì •: { question, file_name, file_base64 }
          const payload = {
            question,
            ...(file_name && file_base64 ? { file_name, file_base64 } : {})
          };

          const r = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const contentType = r.headers.get("content-type") || "";
          if (contentType.includes("application/json")) {
            const data = await r.json();
            answerEl.textContent =
              (data && data.answer) ? data.answer : JSON.stringify(data, null, 2);
          } else {
            const text = await r.text();
            answerEl.textContent = text;
          }
        } catch (e) {
          answerEl.textContent = "ì—ëŸ¬: " + e.message;
        } finally {
          sendBtn.disabled = false;
        }
      };
    </script>
  </body>
</html>
